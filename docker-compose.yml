services:
  # Scheduler for automated sync/build
  ofelia:
    image: mcuadros/ofelia:latest
    container_name: ofelia
    depends_on:
      - tg-archive
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  tg-archive:
    build: .
    image: tg-archive:latest
    container_name: tg-archive
    volumes:
      # Persistent data directory containing config, database, session, and output
      - ./data:/data
    environment:
      - TZ=UTC
    # Interactive mode needed for first-time Telegram auth
    stdin_open: true
    tty: true
    # Keep container running for scheduled jobs
    command: ["tail", "-f", "/dev/null"]
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.sync.schedule: "* * * * *"
      ofelia.job-exec.sync.command: "sh -c 'tg-archive --sync && tg-archive --build'"
      ofelia.job-exec.sync.no-overlap: "true"

  # One-time setup service for Telegram authentication
  tg-auth:
    build: .
    image: tg-archive:latest
    container_name: tg-archive-auth
    volumes:
      - ./data:/data
    stdin_open: true
    tty: true
    command: ["tg-archive", "--sync"]
    profiles:
      - auth

  # Build-only service (no sync)
  tg-build:
    build: .
    image: tg-archive:latest
    container_name: tg-archive-build
    volumes:
      - ./data:/data
    command: ["tg-archive", "--build"]
    profiles:
      - build
