volumes:
  tg-archive-data:
    external: true

services:
  # Scheduler for automated sync/build
  ofelia:
    image: mcuadros/ofelia:latest
    container_name: ofelia
    depends_on:
      - tg-archive
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  tg-archive:
    build: .
    image: tg-archive:latest
    container_name: tg-archive
    volumes:
      # Persistent data directory containing config, database, session, and output
      - tg-archive-data:/data
    environment:
      - TZ=UTC
    # Interactive mode needed for first-time Telegram auth
    stdin_open: true
    tty: true
    # Keep container running for scheduled jobs
    command: ["tail", "-f", "/dev/null"]
    labels:
      ofelia.enabled: "true"
      # Sync every minute
      ofelia.job-exec.sync.schedule: "* * * * *"
      ofelia.job-exec.sync.command: "tg-archive --sync"
      ofelia.job-exec.sync.no-overlap: "true"
      # Build once daily at midnight
      ofelia.job-exec.build.schedule: "0 0 * * *"
      ofelia.job-exec.build.command: "tg-archive --build"
      ofelia.job-exec.build.no-overlap: "true"

  # One-time setup service for Telegram authentication
  tg-auth:
    build: .
    image: tg-archive:latest
    container_name: tg-archive-auth
    volumes:
      - tg-archive-data:/data
    stdin_open: true
    tty: true
    command: ["tg-archive", "--sync"]
    profiles:
      - auth

  # Build-only service (no sync)
  tg-build:
    build: .
    image: tg-archive:latest
    container_name: tg-archive-build
    volumes:
      - tg-archive-data:/data
    command: ["tg-archive", "--build"]
    profiles:
      - build
